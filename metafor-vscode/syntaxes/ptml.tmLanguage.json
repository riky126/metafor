{
    "scopeName": "source.ptml",
    "injections": {
        "text.html.basic": {
            "patterns": [
                {
                    "include": "#control-flow"
                },
                {
                    "include": "#embedded-python"
                }
            ]
        }
    },
    "patterns": [
        {
            "include": "#ptml-block"
        },
        {
            "include": "#style-block"
        },
        {
            "include": "#control-flow"
        },
        {
            "include": "#python-block"
        },
        {
            "include": "#chain-operator"
        },
        {
            "match": "<-",
            "name": "keyword.operator.chain.ptml"
        },
        {
            "include": "source.python"
        }
    ],
    "repository": {
        "ptml-content": {
            "patterns": [
                {
                    "include": "#embedded-python"
                },
                {
                    "include": "#control-flow"
                },
                {
                    "include": "#chain-operator"
                },
                {
                    "include": "text.html.basic"
                }
            ]
        },
        "chain-operator": {
            "match": "->",
            "name": "keyword.operator.chain.ptml"
        },
        "control-flow": {
            "patterns": [
                {
                    "begin": "(@(?:foreach|if|elif|else|repeat|switch|match|fallback))\\s*(?:(.*?)\\s*)?(\\{)",
                    "beginCaptures": {
                        "1": {
                            "name": "entity.name.function.decorator.ptml"
                        },
                        "2": {
                            "patterns": [
                                {
                                    "include": "source.python"
                                }
                            ]
                        },
                        "3": {
                            "name": "punctuation.section.block.begin.ptml"
                        }
                    },
                    "end": "\\}",
                    "endCaptures": {
                        "0": {
                            "name": "punctuation.section.block.end.ptml"
                        }
                    },
                    "patterns": [
                        {
                            "include": "#ptml-content"
                        }
                    ]
                },
                {
                    "match": "(@(?:foreach|if|elif|else|repeat|switch|match|fallback))\\b",
                    "name": "entity.name.function.decorator.ptml"
                }
            ]
        },
        "python-block": {
            "begin": "((?:(?:<-)\\s*)?(?:@[a-zA-Z_]\\w*(?:\\([^)]*\\))?\\s*)+)(\\{)",
            "beginCaptures": {
                "1": {
                    "patterns": [
                        {
                            "match": "<-",
                            "name": "keyword.operator.chain.ptml"
                        },
                        {
                            "include": "source.python"
                        }
                    ]
                },
                "2": {
                    "name": "punctuation.section.block.begin.ptml"
                }
            },
            "end": "\\}",
            "endCaptures": {
                "0": {
                    "name": "punctuation.section.block.end.ptml"
                }
            },
            "patterns": [
                {
                    "include": "#nested-braces"
                },
                {
                    "include": "#metafor-keywords"
                },
                {
                    "include": "source.python"
                }
            ]
        },
        "nested-braces": {
            "begin": "\\{",
            "beginCaptures": {
                "0": {
                    "include": "source.python"
                }
            },
            "end": "\\}",
            "endCaptures": {
                "0": {
                    "include": "source.python"
                }
            },
            "patterns": [
                {
                    "include": "#nested-braces"
                },
                {
                    "include": "#metafor-keywords"
                },
                {
                    "include": "source.python"
                }
            ]
        },
        "metafor-keywords": {
            "patterns": [
                {
                    "match": "@(value|val)\\b",
                    "name": "keyword.control.directive.value.ptml"
                }
            ]
        },
        "ptml-block": {
            "begin": "(@ptml)\\s*(\\{)",
            "beginCaptures": {
                "1": {
                    "patterns": [
                        {
                            "include": "source.python"
                        }
                    ]
                },
                "2": {
                    "name": "punctuation.section.block.begin.ptml"
                }
            },
            "end": "\\}",
            "endCaptures": {
                "0": {
                    "name": "punctuation.section.block.end.ptml"
                }
            },
            "patterns": [
                {
                    "include": "#ptml-content"
                }
            ]
        },
        "embedded-python": {
            "begin": "@\\{",
            "beginCaptures": {
                "0": {
                    "name": "punctuation.section.embedded.begin.ptml"
                }
            },
            "end": "\\}",
            "endCaptures": {
                "0": {
                    "name": "punctuation.section.embedded.end.ptml"
                }
            },
            "patterns": [
                {
                    "include": "#nested-braces"
                },
                {
                    "include": "source.python"
                }
            ]
        },
        "style-block": {
            "patterns": [
                {
                    "begin": "(@style(?:\\([^)]*\\))?)\\s*(\\{)",
                    "beginCaptures": {
                        "1": {
                            "name": "meta.directive.style.ptml",
                            "patterns": [
                                {
                                    "include": "source.python"
                                }
                            ]
                        },
                        "2": {
                            "name": "punctuation.section.block.begin.ptml"
                        }
                    },
                    "end": "\\}",
                    "endCaptures": {
                        "0": {
                            "name": "punctuation.section.block.end.ptml"
                        }
                    },
                    "patterns": [
                        {
                            "include": "source.css"
                        }
                    ]
                },
                {
                    "match": "(@style(?:\\([^)]*\\))?)",
                    "name": "meta.directive.style.ptml",
                    "captures": {
                        "1": {
                            "patterns": [
                                {
                                    "include": "source.python"
                                }
                            ]
                        }
                    }
                }
            ]
        }
    }
}